<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理中心 - 书籍验证系统</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1.1em;
        }
        
        .data-table {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-activated {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .filter-section {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1em;
            min-width: 200px;
        }
        
        .export-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .charts-section {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="header">
            <h1>📊 管理中心</h1>
            <p class="subtitle">书籍验证系统数据统计</p>
        </div>

        <!-- 统计卡片 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCodes">0</div>
                <div class="stat-label">总验证码数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activatedCodes">0</div>
                <div class="stat-label">已激活数量</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingCodes">0</div>
                <div class="stat-label">待激活数量</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activationRate">0%</div>
                <div class="stat-label">激活率</div>
            </div>
        </div>

        <!-- 筛选和导出 -->
        <div class="filter-section">
            <input type="text" id="searchInput" class="filter-input" placeholder="搜索验证码...">
            <select id="statusFilter" class="filter-input">
                <option value="">所有状态</option>
                <option value="activated">已激活</option>
                <option value="pending">待激活</option>
            </select>
            <button class="export-btn" onclick="exportData()">📥 导出数据</button>
            <button class="export-btn" onclick="refreshData()">🔄 刷新数据</button>
        </div>

        <!-- 数据表格 -->
        <div class="data-table">
            <h3>验证码详情</h3>
            <table id="codesTable">
                <thead>
                    <tr>
                        <th>验证码</th>
                        <th>创建时间</th>
                        <th>状态</th>
                        <th>激活时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="codesTableBody">
                    <!-- 数据将通过JavaScript动态插入 -->
                </tbody>
            </table>
        </div>

        <!-- 图表区域 -->
        <div class="charts-section">
            <h3>激活趋势</h3>
            <div class="chart-container" id="chartContainer">
                <canvas id="activationChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        class AdminPanel {
            constructor() {
                this.codes = [];
                this.filteredCodes = [];
                this.init();
            }

            async init() {
                await this.loadData();
                this.setupEventListeners();
                this.updateStats();
                this.renderTable();
            }

            async loadData() {
                try {
                    // 从本地存储加载数据（演示用）
                    const codesData = localStorage.getItem('codes');
                    const activationsData = localStorage.getItem('activations');
                    
                    if (codesData) {
                        this.codes = JSON.parse(codesData);
                    } else {
                        // 生成一些示例数据
                        this.codes = this.generateSampleData();
                        localStorage.setItem('codes', JSON.stringify(this.codes));
                    }

                    // 合并激活数据
                    if (activationsData) {
                        const activations = JSON.parse(activationsData);
                        this.mergeActivationData(activations);
                    }

                    this.filteredCodes = [...this.codes];
                    
                } catch (error) {
                    console.error('加载数据失败:', error);
                    this.codes = this.generateSampleData();
                    this.filteredCodes = [...this.codes];
                }
            }

            generateSampleData() {
                const sampleCodes = [];
                const statuses = ['activated', 'pending'];
                
                for (let i = 0; i < 20; i++) {
                    const code = this.generateRandomCode();
                    const status = statuses[Math.floor(Math.random() * statuses.length)];
                    const createdDate = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                    
                    sampleCodes.push({
                        code: code,
                        created_date: createdDate.toISOString(),
                        activated: status === 'activated',
                        activation_date: status === 'activated' ? 
                            new Date(createdDate.getTime() + Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString() : 
                            null
                    });
                }
                
                return sampleCodes;
            }

            generateRandomCode() {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for (let i = 0; i < 12; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return code;
            }

            mergeActivationData(activations) {
                activations.forEach(activation => {
                    const code = this.codes.find(c => c.code === activation.code);
                    if (code && !code.activated) {
                        code.activated = true;
                        code.activation_date = activation.activation_time;
                    }
                });
            }

            setupEventListeners() {
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filterCodes();
                });

                document.getElementById('statusFilter').addEventListener('change', (e) => {
                    this.filterCodes();
                });
            }

            filterCodes() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;

                this.filteredCodes = this.codes.filter(code => {
                    const matchesSearch = code.code.toLowerCase().includes(searchTerm);
                    const matchesStatus = !statusFilter || 
                        (statusFilter === 'activated' && code.activated) ||
                        (statusFilter === 'pending' && !code.activated);
                    
                    return matchesSearch && matchesStatus;
                });

                this.renderTable();
            }

            updateStats() {
                const total = this.codes.length;
                const activated = this.codes.filter(c => c.activated).length;
                const pending = total - activated;
                const rate = total > 0 ? Math.round((activated / total) * 100) : 0;

                document.getElementById('totalCodes').textContent = total;
                document.getElementById('activatedCodes').textContent = activated;
                document.getElementById('pendingCodes').textContent = pending;
                document.getElementById('activationRate').textContent = rate + '%';
            }

            renderTable() {
                const tbody = document.getElementById('codesTableBody');
                tbody.innerHTML = '';

                this.filteredCodes.forEach(code => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${code.code}</strong></td>
                        <td>${new Date(code.created_date).toLocaleString('zh-CN')}</td>
                        <td>
                            <span class="status-badge ${code.activated ? 'status-activated' : 'status-pending'}">
                                ${code.activated ? '已激活' : '待激活'}
                            </span>
                        </td>
                        <td>${code.activation_date ? new Date(code.activation_date).toLocaleString('zh-CN') : '-'}</td>
                        <td>
                            <button onclick="admin.viewDetails('${code.code}')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8em;">
                                查看详情
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            viewDetails(code) {
                const codeData = this.codes.find(c => c.code === code);
                if (codeData) {
                    const details = `
验证码：${codeData.code}
创建时间：${new Date(codeData.created_date).toLocaleString('zh-CN')}
状态：${codeData.activated ? '已激活' : '待激活'}
激活时间：${codeData.activation_date ? new Date(codeData.activation_date).toLocaleString('zh-CN') : '未激活'}
                    `;
                    alert(details);
                }
            }

            exportData() {
                const csvContent = this.generateCSV();
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `verification_codes_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }

            generateCSV() {
                const headers = ['验证码', '创建时间', '状态', '激活时间'];
                const rows = this.codes.map(code => [
                    code.code,
                    new Date(code.created_date).toLocaleString('zh-CN'),
                    code.activated ? '已激活' : '待激活',
                    code.activation_date ? new Date(code.activation_date).toLocaleString('zh-CN') : '未激活'
                ]);

                return [headers, ...rows].map(row => row.join(',')).join('\n');
            }

            async refreshData() {
                await this.loadData();
                this.updateStats();
                this.renderTable();
                alert('数据已刷新');
            }
        }

        // 全局变量，供按钮调用
        let admin;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            admin = new AdminPanel();
        });

        // 全局函数
        function exportData() {
            admin.exportData();
        }

        function refreshData() {
            admin.refreshData();
        }
    </script>
</body>
</html> 